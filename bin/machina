#!/usr/bin/env node


var child_process = require('child_process');
var fs            = require('fs');
var docopt        = require('docopt').docopt;
var CONF          = require('../lib/conf');


var doc = "Usage: \n" +
          "  machina init (start | stop) [-d | --development] \n" +
          "  machina -h | --help \n" +
          "  machina --version \n" +
          "  \n" +
          "Options: \n" +
          "  -h --help         Show this help. \n" +
          "  -d --development  Start as a normal process. PID file goes to './machina.pid'. \n";

var args = docopt(doc, {version: '0.0.1'});


if (args.init)
{
    if (args.start)
    {
        var log = CONF.log || '../logs/machina.log';
        
        var out = fs.openSync(log, 'a');
        var err = fs.openSync(log, 'a');
        
        var devOption = (args['--development'] ? '--development' : '');
        
        var child = child_process.spawn('node', ['../lib/machina', devOption], {detached: true, stdio: ['ignore', out, err]});
        
        child.unref();
    }
    else if (args.stop && args['--development'])
    {
        var pid = fs.readFileSync('machina.pid', 'utf-8');
        
        process.kill(pid, 'SIGTERM');
    }
}

process.exit();
